#cloud-config
# Nginx Redirector Cloud-Init Script

package_update: true
package_upgrade: true

packages:
  - nginx
  - certbot
  - python3-certbot-nginx
  - ufw

write_files:
  - path: /etc/nginx/sites-available/redirector
    content: |
      upstream c2_backend {
          server ${c2_ip}:${c2_port};
      }
      server {
          listen 80;
          server_name ${domain};
          location /.well-known/acme-challenge/ {
              root /var/www/html;
          }
          location / {
              return 301 https://$$server_name$$request_uri;
          }
      }
      server {
          listen 443 ssl http2;
          server_name ${domain};
          ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
          ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
          ssl_protocols TLSv1.2 TLSv1.3;
          add_header Server "nginx/1.18.0 (Ubuntu)" always;
          access_log /var/log/nginx/redirector_access.log;
          error_log /var/log/nginx/redirector_error.log;
          if ($$http_user_agent ~* "(bot|spider|crawler|scanner|curl|wget|python|nmap|masscan)") {
              return 403;
          }
          location ~ ^/api/ {
              proxy_pass https://c2_backend;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_ssl_verify off;
              proxy_redirect off;
              proxy_buffering off;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $$http_upgrade;
              proxy_set_header Connection "upgrade";
          }
          location / {
              root /var/www/html;
              index index.html;
              try_files $$uri $$uri/ =404;
          }
      }
  
  - path: /var/www/html/index.html
    content: |
      <!DOCTYPE html>
      <html><head><title>Welcome</title>
      <style>body{font-family:Arial;background:#667eea;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
      .container{background:white;padding:60px;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center}
      h1{color:#667eea;font-size:2.5em;margin-bottom:20px}p{color:#666;font-size:1.2em}</style></head>
      <body><div class="container"><h1>ðŸš€ Under Construction</h1>
      <p>This website is currently being developed.</p><p>Check back soon!</p></div></body></html>

runcmd:
  # Enable site
  - rm -f /etc/nginx/sites-enabled/default
  - ln -s /etc/nginx/sites-available/redirector /etc/nginx/sites-enabled/
  - nginx -t
  - systemctl restart nginx
  
  # Firewall
  - ufw --force enable
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  
  # Wait for DNS propagation and get SSL cert
  - sleep 60
  - certbot --nginx -d ${domain} --non-interactive --agree-tos -m ${admin_email} --redirect || true

final_message: "Redirector deployment complete after $UPTIME seconds"
